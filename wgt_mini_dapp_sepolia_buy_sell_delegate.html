<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WGT Mini DApp (Sepolia)</title>
  <style>
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;max-width:900px;margin:24px auto;padding:0 16px}
    .card{border:1px solid #ddd;border-radius:14px;padding:16px;margin:12px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > *{flex:1 1 260px}
    button{padding:10px 14px;border-radius:10px;border:1px solid #333;background:#111;color:#fff;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    input{padding:10px;border-radius:10px;border:1px solid #bbb;width:100%}
    .muted{color:#666;font-size:.9em}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .ok{color:#0a7d32}
    .warn{color:#b85b00}
    .err{color:#b3001b}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#f1f1f1;margin-left:8px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.min.js"></script>
</head>
<body>
  <h1>WGT Mini DApp (Sepolia)</h1>
  <p class="muted">コントラクト: <span class="mono" id="addr">0xa814146ccE08EC174eC7A5ad05e8C350376f5A92</span> <span class="pill">Chain: Sepolia (11155111)</span></p>

  <div class="card">
    <div class="row">
      <button id="btnConnect">ウォレット接続</button>
      <button id="btnRefresh" disabled>更新</button>
    </div>
    <p>アドレス: <span id="who" class="mono">-</span></p>
    <p>ETH 残高: <span id="eth">-</span> ETH / WGT 残高: <span id="wgt">-</span> / Votes: <span id="votes">-</span></p>
    <p>総供給: <span id="supply">-</span> WGT / コントラクトETH: <span id="reserve">-</span> ETH</p>
    <p id="netwarn" class="warn" style="display:none">⚠ Sepolia(11155111) に切り替えてください。</p>
  </div>

  <div class="card">
    <h3>買う (Buy)</h3>
    <div class="row">
      <div>
        <label>数量 (WGT)
          <input id="buyAmt" placeholder="例: 1" />
        </label>
      </div>
      <div>
        <label>見積
          <input id="buyQuote" readonly placeholder="見積(ETH)" />
        </label>
      </div>
    </div>
    <div class="row">
      <button id="btnQuoteBuy" disabled>見積 (quoteBuy)</button>
      <button id="btnBuy" disabled>購入 (buy)</button>
    </div>
    <p class="muted">手数料: コントラクト設定に基づく（現在 1%）。購入時は <b>grossETH + feeETH</b> を自動で value に送ります。</p>
  </div>

  <div class="card">
    <h3>売る (Sell)</h3>
    <div class="row">
      <div>
        <label>数量 (WGT)
          <input id="sellAmt" placeholder="例: 0.1" />
        </label>
      </div>
      <div>
        <label>見積
          <input id="sellQuote" readonly placeholder="受取見込(ETH)" />
        </label>
      </div>
    </div>
    <div class="row">
      <button id="btnQuoteSell" disabled>見積 (quoteSell)</button>
      <button id="btnSell" disabled>売却 (sell)</button>
    </div>
    <p class="muted">※ 売却にはコントラクトのリザーブが必要。フロア未満になる売りは失敗します。</p>
  </div>

  <div class="card">
    <h3>投票権 (Delegate)</h3>
    <div class="row">
      <button id="btnDelegate" disabled>自己委任</button>
    </div>
    <p class="muted">Votes は保有量とは別。<b>delegate(自分のアドレス)</b> で有効化されます。</p>
  </div>

  <div class="card">
    <h3>ログ</h3>
    <pre id="log" class="mono" style="white-space:pre-wrap"></pre>
  </div>

<script>
(async () => {
  const CONTRACT = "0xa814146ccE08EC174eC7A5ad05e8C350376f5A92";
  const CHAIN_ID = 11155111; // Sepolia
  const ABI = [
    "function decimals() view returns (uint8)",
    "function balanceOf(address) view returns (uint256)",
    "function totalSupply() view returns (uint256)",
    "function getVotes(address) view returns (uint256)",
    "function delegates(address) view returns (address)",
    "function delegate(address)",
    "function quoteBuy(uint256) view returns (uint256 grossETH, uint256 feeETH)",
    "function quoteSell(uint256) view returns (uint256 grossETH, uint256 feeETH)",
    "function buy(uint256 amount, uint256 maxCostETH) payable",
    "function sell(uint256 amount, uint256 minPayoutETH)",
    "function owner() view returns (address)"
  ];

  const $ = (id) => document.getElementById(id);
  const log = (m, cls) => { const el = $("log"); const line = document.createElement("div"); if(cls) line.className = cls; line.textContent = (new Date()).toLocaleTimeString()+"  "+m; el.prepend(line); };

  let provider, signer, wgt, acct, decimals=18;

  async function ensureNetwork() {
    const net = await provider.send('eth_chainId', []);
    const current = parseInt(net, 16);
    const warn = $("netwarn");
    if (current !== CHAIN_ID) {
      warn.style.display = '';
      try {
        await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0xAA36A7' }] });
        warn.style.display = 'none';
        return true;
      } catch (e) {
        log("ネットワーク切替が必要です (Sepolia)", 'warn');
        return false;
      }
    } else {
      warn.style.display = 'none';
      return true;
    }
  }

  async function connect() {
    if (!window.ethereum) { alert('MetaMask 等のウォレットを入れてください'); return; }
    provider = new ethers.BrowserProvider(window.ethereum);
    await provider.send('eth_requestAccounts', []);
    const ok = await ensureNetwork(); if (!ok) return;
    signer = await provider.getSigner();
    acct = await signer.getAddress();
    wgt = new ethers.Contract(CONTRACT, ABI, signer);
    try { decimals = await wgt.decimals(); } catch {}

    $("who").textContent = acct;
    $("btnRefresh").disabled = false;
    ["btnQuoteBuy","btnBuy","btnQuoteSell","btnSell","btnDelegate"].forEach(id=>$(id).disabled=false);
    await refresh();
  }

  async function refresh() {
    if (!provider) return;
    const ethBal = await provider.getBalance(acct);
    const w = await wgt.balanceOf(acct);
    const v = await wgt.getVotes(acct);
    const ts = await wgt.totalSupply();
    const res = await provider.getBalance(CONTRACT);
    $("eth").textContent = ethers.formatEther(ethBal);
    $("wgt").textContent = ethers.formatUnits(w, decimals);
    $("votes").textContent = ethers.formatUnits(v, decimals);
    $("supply").textContent = ethers.formatUnits(ts, decimals);
    $("reserve").textContent = ethers.formatEther(res);
  }

  async function quoteBuy() {
    const amt = $("buyAmt").value.trim() || "0";
    const n = ethers.parseUnits(amt, decimals);
    const [gross, fee] = await wgt.quoteBuy(n);
    const total = gross + fee;
    $("buyQuote").value = ethers.formatEther(total) + ` ETH (内 fee ${ethers.formatEther(fee)} ETH)`;
    return { n, gross, fee, total };
  }
  async function doBuy() {
    const { n, total } = await quoteBuy();
    const max = total * 101n / 100n; // +1%スリッページ
    const tx = await wgt.buy(n, max, { value: total });
    log(`buy 送信: ${tx.hash}`);
    const rc = await tx.wait();
    log(`buy 成功: block ${rc.blockNumber}`, 'ok');
    await refresh();
  }

  async function quoteSell() {
    const amt = $("sellAmt").value.trim() || "0";
    const n = ethers.parseUnits(amt, decimals);
    const [gross, fee] = await wgt.quoteSell(n);
    const net = gross - fee;
    $("sellQuote").value = ethers.formatEther(net) + ` ETH (fee ${ethers.formatEther(fee)} ETH)`;
    return { n, gross, fee, net };
  }
  async function doSell() {
    const { n, net } = await quoteSell();
    const min = net * 99n / 100n; // -1% スリッページ許容
    const tx = await wgt.sell(n, min);
    log(`sell 送信: ${tx.hash}`);
    const rc = await tx.wait();
    log(`sell 成功: block ${rc.blockNumber}`, 'ok');
    await refresh();
  }

  async function doDelegate() {
    const tx = await wgt.delegate(acct);
    log(`delegate 送信: ${tx.hash}`);
    const rc = await tx.wait();
    log(`delegate 成功: block ${rc.blockNumber}`, 'ok');
    await refresh();
  }

  $("btnConnect").onclick = connect;
  $("btnRefresh").onclick = refresh;
  $("btnQuoteBuy").onclick = quoteBuy;
  $("btnBuy").onclick = doBuy;
  $("btnQuoteSell").onclick = quoteSell;
  $("btnSell").onclick = doSell;
  $("btnDelegate").onclick = doDelegate;
})();
</script>
</body>
</html>
